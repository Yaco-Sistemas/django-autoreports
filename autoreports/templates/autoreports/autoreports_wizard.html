{% extends template_base %}
{% load i18n %}

{% block title %}
    {% trans "Wizard Report" %} {{ block.super }}
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    {% include "autoreports/inc.jslibraries.html" %}
    <script type="text/javascript">
        var dragged = Array();
        (function($){
            $(document).ready(function () {
                {% block is_admin %}
                    var is_admin = false;
                {% endblock %}

                $(".droppable").css({height: $('.wizard').height() + 20 + 'px'});
                $(".droppable h2").css({top: $(document).scrollTop() + 150 + 'px'});

                function initialWizard() {
                    // enable just for those which haven't been explicitly disabled
                    $(".draggable a:not(.ui-draggable-disabled)").draggable({
                        revert: "invalid",
                        start: function(event, ui){
                            $(".droppable").addClass('dropping');
                            $(".droppable").css({height: $('.wizard').height() + 20 + 'px'});
                            $(".droppable h2").css({top: $(document).scrollTop() + 150 + 'px'});
                        },
                        stop: function(event, ui){
                            $(".droppable").removeClass('dropping');
                        }
                    });

                    $(".droppable").droppable({
                        drop: requestFieldSet,
                        hoverClass: 'dropping_hover'
                    });
                }

                $(".collapsable h2").live("click", function() {
                    var fieldset = $(this).parent();
                    if($(this).hasClass("hidden")) {
                        fieldset.find("div").fadeIn();
                        $(this).removeClass("hidden");
                    } else {
                        fieldset.find("div").fadeOut();
                        $(this).addClass("hidden");
                    }
                });

                $(".removeAdaptor").live("click", function() {
                    $(this).parent().remove();

                    // enable dragging again
                    var label_idx = $(this).attr('rel');
                    dragged[label_idx].draggable.draggable("enable", 1);
                    $(dragged[label_idx].draggable).removeClass("using");
                    dragged[label_idx] = null;
                });

                initialWizard();

                function requestFieldSet(event, ui) {
                    $("fieldset.collapsable").find("h2").not("h2.hidden").click();
                    var field = ui.draggable.parent();
                    var field_label = $(field.find("a")[0]);
                    field_label.css({top: "0px", left:"0px"});
                    field_label.addClass('using');

                    var field_name = field.find("a").attr("href").replace("#", "");
                    var config = field.parents("div.model").children().first()
                    var module_name = config.find(".module_name").html();
                    var app_label = config.find(".app_label").html();
                    var url = "{% url reports_ajax_fields_options %}" + "?app_label=" + app_label + "&module_name=" + module_name;
                    url+= "&field=" + field_name + "&is_admin=" + is_admin;
                    $.ajax({
                            url: url,
                            type: "GET",
                            async: true,
                            dataType: 'html',
                            success: function(response){
                                var wizard = $(".wizard");
                                var prefix = $(response).find("input").attr("id").replace("id_", "").split("-")[0];
                                var old_prefixes = $("#id_prefixes").val();
                                if (!old_prefixes) {
                                    $("#id_prefixes").val(prefix);
                                } else {
                                    $("#id_prefixes").val(old_prefixes + ", "  + prefix);
                                }
                                $(response).insertAfter(wizard.find("h2:first"));

                                // avoid dragging the same element again
                                var idx = dragged.push(ui);
                                ui.draggable.draggable("disable", 1);
                                $(wizard.find('.removeAdaptor')[0]).attr({rel:idx-1});

                                initialWizard();
                                $('.droppable').removeClass('void');
                            }
                    });
                }

                $("li.collapsible span").live("click", function() {
                    var field = $(this).parent();
                    if(field.find("div.model").length == 0){
                        var field_name = field.find("a").attr("href").replace("#", "");
                        var module_name = $(this).find(".module_name").html();
                        var app_label = $(this).find(".app_label").html();
                        var ignore_app_label = "";
                        var ignore_module_name = "";
                        var separated = "";
                        $.map($(this).parents().find(".config"), function (config, i) {
                            if (i > 0) {
                                separated = "/";
                            }
                            ignore_app_label += separated + $(config).find(".app_label").html();
                            ignore_module_name += separated + $(config).find(".module_name").html();
                        });

                        var url = "{% url reports_ajax_fields %}" + "?app_label=" + app_label + "&module_name=" + module_name;
                        url += "&field=" + field_name + "&is_admin=" + is_admin;
                        url += "&ignore_app_label=" + ignore_app_label + "&ignore_module_name=" + ignore_module_name;
                        $.ajax({
                                url: url,
                                type: "GET",
                                async: true,
                                dataType: 'html',
                                success: function(response){
                                    var resp = $(response);
                                    resp.css({display: 'none'});
                                    field.append(resp);
                                    resp.slideDown();
                                    initialWizard();
                                }
                        });
                    } else {
                        var child = field.find("div.model");
                        if (!child.hasClass("hidden")){
                            field.find("div.model").slideUp();
                            child.addClass("hidden");
                        }else {
                            field.find("div.model").slideDown();
                            child.removeClass("hidden");
                        }
                    }
                    return false;
                });
            });
        })(jQuery);
    </script>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
     <a href="../../">{% trans "Home" %}</a> &rsaquo;
     <a href="../">{% trans "Reports" %}</a> &rsaquo;
     {% if report %}
        {{ report }}
     {% else %}
        {% trans "Wizard Report" %}
     {% endif %}
</div>
{% endblock %}


{% block content %}
    {% block contenttitle %}
        <h1>{% trans "Wizard Form" %}</h1>
    {% endblock %}
    <div class="leftsidebar">
        {% include "autoreports/inc.render_model.html" %}
    </div>
    <div id="content-main" class="rightsidebar {% block contentextraclass %} {% endblock %}">
        <form action="." method="post" class="report">
            <div class="app_label" style="display:none">{{ app_label }}</div>
            <div class="module_name" style="display:none">{{ module_name }}</div>
            {% block contentform %}
                {% block contentformname %}
                    {{ form_top.as_p }}
                {% endblock %}
                {% block contentformmodel %}
                    <div class="droppable {% if not adaptors %}dropping void{% endif %}">
                        <h2>{% trans "Drop the fields here" %}</h2>
                    </div>
                    <div class="wizard">
                        <h2>{% trans "Selected fields" %}</h2>
                        {% for adaptor in adaptors %}
                            {{ adaptor.render_instance|safe }}
                        {% endfor %}
                    </div>
                {% endblock %}
            {% endblock %}
            {% block submitwrapper %}
            <div class="submit-row">
                {% block submit %}
                    <input type="submit" name="__report_wizard" class="default" value="{% trans "Create a report" %}"/>
                {% endblock %}
            </div>
            {% endblock %}
        </form>
    </div>
{% endblock %}
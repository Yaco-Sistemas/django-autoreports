{% extends template_base %}
{% load i18n %}

{% block title %}
    {% trans "Wizard Report" %} {{ block.super }}
{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script type="text/javascript" src="{{ MEDIA_URL }}js/jquery-1.4.2.min.js"></script>
    <script type="text/javascript">
        (function($){
            $(document).ready(function () {
                $("tr.fields").fadeOut();
                $("div.advanced_options").fadeOut();

                function title_click(){
                    var id = $(this).parent().parent().parent().attr("id");
                    if (!$("tr." + id).hasClass("visibility")) {
                        $("tr." + id).fadeIn();
                        $("tr." + id).addClass("visibility");
                    }
                    else {
                        $("tr." + id).fadeOut();
                        $("tr." + id).removeClass("visibility");
                    }
                    return false;
                }

                function field_click(){
                    var link = $(this);
                    var tr_link = link.parent().parent().parent();
                    var model = link.attr("href").split("/");
                    var prefix = link.parent().attr("for").replace('id_', '');
                    var url = "{% url reports_ajax_fields %}" + "?app_label=" + model[0] + "&module_name=" + model[1] + "&prefix=" + prefix;
                    if (tr_link.next().find("table").length == 0) {
                        $.ajax({
                            url: url,
                            type: "GET",
                            async: true,
                            dataType: 'text/html',
                            success: function(response){
                                tr_link.after('<tr class="visibility"><td colspan="5">' + response + '</tr></tr>');
                                tr_link.next().find("table tr.fields").fadeOut();
                                tr_link.next().find("table tr.title h3 a").click(title_click);
                                tr_link.next().find("table tr.fields label a").click(field_click);
                                tr_link.next().find("table tr.fields a.change_widget").click(change_widget_click);
                                tr_link.next().find("table tr.fields a.default_value").click(default_value_click);
                            }
                        });
                    }
                    else {
                        if (tr_link.next().hasClass("visibility")){
                            tr_link.next().fadeOut();
                            tr_link.next().removeClass("visibility");
                        }
                        else {
                            tr_link.next().fadeIn();
                            tr_link.next().addClass("visibility");
                        }
                    }
                    return false;
                }

                function advanced_options_click(){
                    var advanced_options = $(this).parent().find("div.advanced_options");
                    if (!advanced_options.hasClass("visibility")) {
                        advanced_options.fadeIn();
                        advanced_options.addClass("visibility");
                    }
                    else {
                        advanced_options.fadeOut();
                        advanced_options.removeClass("visibility");
                    }
                    return false;
                }


                function change_widget_click(){
                    var link = $(this);
                    var app_label = $("div.app_label").html();
                    var module_name = $("div.module_name").html();
                    var prefix = link.attr("href").replace('#', '');
                    var url = "{% url reports_ajax_advanced_options %}" + "?app_label=" + app_label + "&module_name=" + module_name + "&prefix=" + prefix + "&option=change_widget";;
                    $.ajax({
                        url: url,
                        type: "GET",
                        async: true,
                        dataType: 'text/html',
                        success: function(response){
                            link.fadeOut();
                            response = eval("(" + response + ")");
                            var advanced_options = "<label>{% trans 'Choose a widget' %}</label>"
                            advanced_options += "<select name='widget_"+ prefix +"' id='id_widget_"+ prefix +"'>";
                            $.map(response, function(elem, i){
                                advanced_options += "<option value='"+ elem[0] +"'>"+ elem[1] +"</option>"
                            });
                            advanced_options += "</select>";
                            link.parent().find("div.change_widget").html(advanced_options);
                        }
                    });
                    return false;
                }

                function default_value_click(){
                    var link = $(this);
                    var app_label = $("div.app_label").html();
                    var module_name = $("div.module_name").html();
                    var prefix = link.attr("href").replace('#', '');
                    var widget = $("select#id_widget_"+prefix);
                    if (widget.length == 1) {
                        var widget_selected = widget.find("option:selected").val();
                        var url = "{% url reports_ajax_advanced_options %}" + "?app_label=" + app_label + "&module_name=" + module_name + "&prefix=" + prefix + "&widget_selected=" + widget_selected + "&option=default_value";
                        $.ajax({
                            url: url,
                            type: "GET",
                            async: true,
                            dataType: 'text/html',
                            success: function(response){
                                link.parent().find("div.default_value").html(response);
                            }
                        });
                    }
                    else {
                        alert("{% trans 'First Select a widget'%}");
                    }
                    return false;
                }
                $("tr.title h3 a").click(title_click);
                $("tr.fields label a").click(field_click);
                $("a.advanced_options").click(advanced_options_click);
                $("tr.fields a.change_widget").click(change_widget_click);
                $("tr.fields a.default_value").click(default_value_click);
            });
        })(jQuery);
    </script>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
     <a href="../../">{% trans "Home" %}</a> &rsaquo;
     <a href="../">{% trans "Reports" %}</a> &rsaquo;
     {% trans "Wizard Report" %}
</div>
{% endblock %}

{% block content %}
    <h1>{% trans "Wizard Form" %}</h1>
    <div id="content-main">
        <form action="." method="post" class="report">
            <div class="app_label" style="display:none">{{ app_label }}</div>
            <div class="module_name" style="display:none">{{ module_name }}</div>
            {% block contentform %}
                {% block contentformname %}
                    {{ form_name.as_p }}
                {% endblock %}
                {% block contentformmodel %}
                    {% include "autoreports/inc.render_model.html" %}
                {% endblock %}
            {% endblock %}
            <div class="submit-row">
                <input type="submit" name="__report_wizard" class="default" value="{% trans "Create a report" %}"/>
            </div>
        </form>
    </div>
{% endblock %}